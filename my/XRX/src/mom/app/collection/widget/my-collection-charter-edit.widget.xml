<xrx:widget xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xrx="http://www.monasterium.net/NS/xrx" xmlns:xf="http://www.w3.org/2002/xforms">
    <xrx:id>tag:www.monasterium.net,2011:/mom/widget/my-collection-charter-edit</xrx:id>
    <xrx:title>
        <xrx:i18n>
            <xrx:key/>
            <xrx:default/>
        </xrx:i18n>
    </xrx:title>
    <xrx:subtitle/>
    <xrx:description/>
    <xrx:author>jochen.graf@uni-koeln.de</xrx:author>
    <xrx:licence>
This is a component file of the VdU Software for a Virtual Research Environment for the handling of Medieval charters.

As the source code is available here, it is somewhere between an alpha- and a beta-release, may be changed without any consideration of backward compatibility of other parts of the system, therefore, without any notice.

This file is part of the VdU Virtual Research Environment Toolkit (VdU/VRET).

The VdU/VRET is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

VdU/VRET is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with VdU/VRET.  If not, see http://www.gnu.org/licenses.

We expect VdU/VRET to be distributed in the future with a license more lenient towards the inclusion of components into other systems, once it leaves the active development stage.
  </xrx:licence>
    <xrx:variables>
    <!-- request parameter -->
    <xrx:variable>
      <xrx:name>$atomid</xrx:name>
      <xrx:expression>replace(metadata:atomid('charter', $xrx:tokenized-uri), "/edit", "")</xrx:expression>
    </xrx:variable>
    <!-- charter -->
    <xrx:variable>
      <xrx:name>$uuid</xrx:name>
      <xrx:expression> metadata:objectid($atomid)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$colToken</xrx:name>
      <xrx:expression>$xrx:tokenized-uri[1]</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$colToken</xrx:name>
      <xrx:expression>metadata:base-collection('charter', 'saved')</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$base-collection</xrx:name>
      <xrx:expression>if( count( tokenize($colToken, '-') ) = 5 ) then $user:db-base-collection else metadata:base-collection('charter', 'saved')</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$entry</xrx:name>
      <xrx:expression>if(not(exists($base-collection//atom:id[.=$atomid]/parent::atom:entry))) then $user:db-base-collection//atom:id[.=$atomid]/parent::atom:entry else $base-collection//atom:id[.=$atomid]/parent::atom:entry</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$updater</xrx:name>
      <xrx:expression>mycollection:checkUpdateCharter($entry)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$nodes-for-editcontrol</xrx:name>
      <xrx:expression>mycollection:return-existend-nodes($entry)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$helper</xrx:name>
      <xrx:expression>mycollection:helper-to-string($nodes-for-editcontrol)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$distinct_nodes</xrx:name>
      <xrx:expression>mycollection:disctinct-mappings($entry, $entry//cei:text)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$atom-from-entry</xrx:name>
      <xrx:expression>$entry//atom:id/text()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$idno</xrx:name>
      <xrx:expression>$entry//cei:body/cei:idno/text()</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$image-urls</xrx:name>
      <xrx:expression>for $url in $entry//cei:graphic/@url/string() return $url</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$folio-names</xrx:name>
      <xrx:expression>for $name in $image-urls return replace($name, "([^_]+)(_|-)([^_]+)(_|-)(.*)", "$5")</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$entry-as-string</xrx:name>
      <xrx:expression>serialize($entry, ())</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$context</xrx:name>
      <xrx:expression>charter:context($atomid, conf:param('atom-tag-name'))</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$uri-tokens</xrx:name>
      <xrx:expression>metadata:uri-tokens($atomid)</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$db-base-collection</xrx:name>
      <xrx:expression>metadata:base-collection($context, $uri-tokens, 'public')</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$fond-entry</xrx:name>
      <xrx:expression>$db-base-collection//ead:ead/ancestor::atom:entry</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$fond-image-base-url</xrx:name>
      <xrx:expression>concat($db-base-collection/xrx:preferences/xrx:param[@name='image-server-base-url'], '/')</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$collection-entry</xrx:name>
      <xrx:expression>$db-base-collection//cei:cei/ancestor::atom:entry</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$collection-image-base-url</xrx:name>
      <xrx:expression>concat('http://', $collection-entry//cei:image_server_address/text(), '/', $collection-entry//cei:image_server_folder/text(), '/')</xrx:expression>
    </xrx:variable>
    <xrx:variable>
      <xrx:name>$image-base-url</xrx:name>
      <xrx:expression>if($context = 'fond') then $fond-image-base-url else $collection-image-base-url</xrx:expression>
    </xrx:variable>
    <!-- linked charter -->
        <xrx:variable>
            <xrx:name>$atomid-linked</xrx:name>
            <xrx:expression>$entry/atom:link/@ref/string()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$is-linked</xrx:name>
            <xrx:expression>$atomid-linked != ''</xrx:expression>
        </xrx:variable>
    <!-- linked charter fond and collection info -->
        <xrx:variable>
            <xrx:name>$context-linked</xrx:name>
            <xrx:expression>if($is-linked) then charter:context($atomid-linked, conf:param('atom-tag-name')) else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$uri-tokens-linked</xrx:name>
            <xrx:expression>if($is-linked) then metadata:uri-tokens($atomid-linked) else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$db-base-collection-linked</xrx:name>
            <xrx:expression>if($is-linked) then metadata:base-collection($context-linked, $uri-tokens-linked, 'public') else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$fond-entry-linked</xrx:name>
            <xrx:expression>if($is-linked) then $db-base-collection-linked//ead:ead/ancestor::atom:entry else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$fond-image-base-url-linked</xrx:name>
            <xrx:expression>if($is-linked) then concat($db-base-collection-linked/xrx:preferences/xrx:param[@name='image-server-base-url'], '/') else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$collection-entry-linked</xrx:name>
            <xrx:expression>if($is-linked) then $db-base-collection-linked//cei:cei/ancestor::atom:entry else()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$collection-image-base-url-linked</xrx:name>
            <xrx:expression>if($is-linked) then concat('http://', $collection-entry-linked//cei:image_server_address/text(), '/', $collection-entry-linked//cei:image_server_folder/text(), '/') else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$image-base-url-linked</xrx:name>
            <xrx:expression>if($context-linked = 'fond') then $fond-image-base-url-linked else $collection-image-base-url-linked</xrx:expression>
        </xrx:variable>
    <!-- linked charter images -->
        <xrx:variable>
            <xrx:name>$objectid-linked</xrx:name>
            <xrx:expression>if($is-linked) then metadata:objectid($atomid-linked) else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$base-collection-linked</xrx:name>
            <xrx:expression>if($is-linked) then metadata:base-collection('charter', $uri-tokens-linked, 'public') else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$entry-linked</xrx:name>
            <xrx:expression>if($is-linked) then $base-collection-linked//atom:id[.=$atomid-linked]/parent::atom:entry else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$image-names-linked</xrx:name>
            <xrx:expression>if($is-linked) then for $name in $entry-linked//cei:graphic/@url/string() return $name else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$image-urls-linked</xrx:name>
            <xrx:expression>if($is-linked) then for $name in $image-names-linked return concat($image-base-url-linked, $name) else ()</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$folio-names-linked</xrx:name>
            <xrx:expression>if($is-linked) then for $name in $image-urls-linked return replace($name, "([^_]+)(_|-)([^_]+)(_|-)(.*)", "$5") else ()</xrx:expression>
        </xrx:variable>
    <!-- all image URLs and folio names -->
        <xrx:variable>
            <xrx:name>$urls</xrx:name>
            <xrx:expression>($image-urls, $image-urls-linked)</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$folios</xrx:name>
            <xrx:expression>($folio-names, $folio-names-linked)</xrx:expression>
        </xrx:variable>
    <!-- mixed content -->
        <xrx:variable>
            <xrx:name>$schema</xrx:name>
            <xrx:expression>$xrx:db-base-collection/xs:schema[@id='cei']</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$xrx-schema</xrx:name>
            <xrx:expression>xsd:get('tag:www.monasterium.net,2011:/mom/xsd/cei-collection-editor')</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$attribute-suggestions</xrx:name>
            <xrx:expression>xmleditor:json-attribute-suggestions($schema)</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$element-suggestions</xrx:name>
            <xrx:expression>xmleditor:json-element-suggestions($schema)</xrx:expression>
        </xrx:variable>
        <xrx:variable>
            <xrx:name>$topics</xrx:name>
            <xrx:expression>xmleditor:json-element-topics($xrx-schema)</xrx:expression>
        </xrx:variable>
    <!-- Annotation Tool service prefix -->
        <xrx:variable>
            <xrx:name>$service-prefix</xrx:name>
            <xrx:expression>xs:string('')</xrx:expression>
        </xrx:variable>
    </xrx:variables>
    <xrx:portal>tag:www.monasterium.net,2011:/mom/portal/empty</xrx:portal>
    <xrx:init>
        <xrx:processor>
            <xrx:xformsflag>false</xrx:xformsflag>
            <xrx:jqueryflag>true</xrx:jqueryflag>
        </xrx:processor>
        <xrx:client>
            <xrx:messages>
                <xrx:catalog>cei</xrx:catalog>
            </xrx:messages>
        </xrx:client>
    </xrx:init>
    <xrx:csss>
        <xrx:css>tag:www.monasterium.net,2011:/mom/css/my-collections</xrx:css>
        <xrx:css>tag:www.monasterium.net,2011:/mom/css/image-tools</xrx:css>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/css/codemirror/lib/codemirror</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/core/resource/css/codemirror/mode/visualxml</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/external/css/layout</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/external/css/imgareaselect</xrx:resource>
        <style type="text/css">

#dmy-collection-charter-edit, #dtextann, #dinner-textann{{
  position:relative;
  float:none;
  display:block;
  width:100%;
  height:100%;
}}
.xrx-layout{{
  display:block;
  position:relative;
  float:left;
  width:100%;
  height:100%;
}}
.xrx-report *{{
  font-size:0.9em;
}}
.xrx-layout .ui-layout-center, .xrx-layout .ui-layout-south, .xrx-layout .ui-layout-east, .xrx-layout .ui-layout-north{{
  padding:0; /* center-container inset will be created by an inset option */
  overflow:hidden;
}}
.dlabel {{
  font-family: Courier, monospace;
  margin-left: 2%;
  margin-top: 2%;
}}
.dlabel-text{{
  position:relative;
}}
.xrx-repeat, .CodeMirror {{
  margin-left: 2%;
}}

fieldset {{
  margin: 2%;
}}

#dviewer-switch, .xrx-case, #icharter{{
  height:100%;
}}
/*
* imageann
*/   
#dui-imageann {{ height:100%; }}
#ui-imageselect .ui-selecting {{ background: #FECA40; }}
#ui-imageselect .ui-selected {{ background: #F39814; color: white; }}
#ui-imageselect {{ list-style-type: none; margin: 0; padding: 0; }}
#ui-imageselect li {{ margin: 0px; padding: 0.4em; font-size: .7em; height: 18px; }}
#ui-imageselect .ui-widget-content {{ cursor:pointer }}
#folio-links{{
  position:absolute;
  right:0px;
  z-index:99;
  background:white;
}}
#folio-links .folio-link{{
  margin:0;
}}
#selected-folio{{
  position:absolute;
  left:0px;
  z-index:99;
  background:white;
}}
#inner-selected-folio{{
  margin:5px;
}}
#s1viewer-choice{{
  position:absolute;
  margin:10px;
  z-index:99;
  font-size:.6em;
}}
#dcharter-instance{{
  white-space:pre-wrap;
  overflow:auto !important;
}}
form{{
  margin:0;
  padding:0;
}}
/*
* table layout
*/
.table{{
  display:table;
}}
.table-row{{
  display:table-row;
}}
.table-cell{{
  width:100%;
  display:table-cell;
}}
.table-cell-value{{
  width:79%;
}}
.table-cell-label{{
  width:19%;
}}
/*
* jQuery UI
*/
.ui-tabs-anchor{{
  font-size:.8em;
}}

span#onoff {{
  padding-bottom:1em;
}}

div.forms-mixedcontent-attribute-droppable {{
  color:#E8E8E8; 
}}
div.controlledVocabulary {{
    font-size: 0.9em;
}}
span#onoff {{
  padding-left:2em;
}}
    </style>
  </xrx:csss>
  <xrx:jss>
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/js/collection</xrx:resource>
    <!-- jQuery resources --> 
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/jquery</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/external/mousewheel</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/core</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/widget</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/mouse</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/draggable</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/resizable</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/selectable</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/button</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/draggable</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/droppable</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/menu</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/ui/tabs</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/external/layout</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jquery/external/imgareaselect</xrx:resource>

    <!-- jssaxparser resources -->
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/XMLFilterImpls</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/NamespaceSupport</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/AttributesImpl</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/SAXScanner</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/ReaderWrapper</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/Reader</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/sax</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/DefaultHandlers</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/jssaxparser/XPath</xrx:resource>
    <!-- codemirror resources -->
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/js/codemirror/lib/codemirror</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/xrx/resource/js/codemirror/mode/xml</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/core/resource/js/codemirror/mode/visualxml</xrx:resource>
        <xrx:resource>tag:www.monasterium.net,2011:/core/resource/js/codemirror/keymap/visualxml</xrx:resource>
    <!-- core resources -->
       <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/xrxBind</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/xrxInstance</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/xrxI18n</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrx</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxLayout</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxTabs</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxSelect1</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxMessage</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxVisualxml</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxElements</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxAttributes</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxTagname</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxReport</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/ui/xrxRepeat</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/core/resource/jquery/xrx</xrx:resource>
    <!-- jquery -->
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/ui/imageann</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/ui/xmleditor</xrx:resource>
    <!-- annotation resources -->
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/i18nText</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/imageTool</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/imageToolWidget</xrx:resource>
    <xrx:resource>tag:www.monasterium.net,2011:/mom/resource/jquery/createanno</xrx:resource>
  </xrx:jss>
  <xrx:instances>
    <xrx:instance id="icharter">{ $entry-as-string }</xrx:instance>
  </xrx:instances>
  <xrx:binds>
    <xrx:bind id="bclass" nodeset="/descendant::cei:class"/>
  </xrx:binds>

  <xrx:view>
    <divs>
      {mycollection:makeBindings($entry, $distinct_nodes)}
  </divs>
    <div data-demoid="393de52d-1b4f-4df8-99b1-e7af26b713fe" id="dmy-collection-charter-edit">
      <xrx:layout>
        <xrx:options>
          <xrx:option key="north__resizable">false</xrx:option>
          <xrx:option key="south__size">.5</xrx:option>
        </xrx:options>
        <xrx:center>
          <xrx:auth>
            <xrx:rules>
              <xrx:rule>
                <xrx:user/>
                <xrx:dbgroup>atom</xrx:dbgroup>
              </xrx:rule>
            </xrx:rules>
            <xrx:true>
              <div data-demoid="09a18129-a5e4-42f7-ab9e-1d4bcf9497bb" id="dui-imageann">
                <script type="text/javascript">
                $(document).ready(function(){{
                  jQuery(document).imageTool({{
                    requestRoot: "{ conf:param('request-root') }",
                    charter: "{ $uuid }",
                    collection: "",
                    scope: "private",
                    servicePrefix: "{ $service-prefix }"
                  }});
                  jQuery(document).i18nText({{
                    lang: "{ $xrx:lang }",
                    requestRoot: "{ conf:param('request-root') }"
                  }});
                  jQuery("input", "#s1viewer-choice").change(function(){{
                      if ($(this).is(':checked')) {{
                          var caseDiv = $(this).val();
                          $(".xrx-case", "#dviewer-switch").hide();
                          $("#"+ caseDiv, "#dviewer-switch").show();
                      }}
                  }});
                  
                }});     
                </script>
                <xrx:select1 appearance="xrx-appearance-buttonset" id="s1viewer-choice">
                  <xrx:item>
                    <xrx:label>
                      <xrx:i18n>
                        <xrx:key>graphics</xrx:key>
                        <xrx:default>Graphics</xrx:default>
                      </xrx:i18n>
                    </xrx:label>
                    <xrx:value>ui-imageann-wrapper</xrx:value>
                  </xrx:item>
                  <xrx:item>
                    <xrx:label>
                      <xrx:i18n>
                        <xrx:key>xml</xrx:key>
                        <xrx:default>XML</xrx:default>
                      </xrx:i18n>
                    </xrx:label>
                    <xrx:value>dcharter-instance</xrx:value>
                  </xrx:item>
                </xrx:select1>
                <xrx:switch id="dviewer-switch">
                  <xrx:case id="ui-imageann-wrapper">
                    <div data-demoid="a4fa4172-275b-4337-8a83-15f398663e76" id="selected-folio">
                      <span id="select-result"/>
                    </div>
                    <div data-demoid="b90a2b1c-9164-49b9-a8cb-f47f1413947c" id="folio-links">
                      <ol id="ui-imageselect">
                        {
                        for $folio at $p in $folios
                        return
                        <li title="{ if(not(contains($urls[$p], '/'))) then concat($image-base-url, $urls[$p]) else $urls[$p]    }">{ if($p = 1) then attribute class { 'ui-widget-content ui-selected' } else attribute class { 'ui-widget-content' } }{ $folio }</li>
                        }
                      </ol>
                    </div>
                    <div data-demoid="f224f11c-46c7-41b3-839d-02eb5f9e278a" id="ui-imageann" style="width:100%;height:100%;position:relative;overflow:hidden;">
                      <div data-demoid="5c720e82-758a-4e64-9b13-a6295c9e833c">
                        <div data-demoid="f1542ed4-df27-4ddb-bb3a-46c629f63f2c" id="img-svg"/>
                        <div data-demoid="0bff0a22-184d-49c8-84bb-3e8eaf390028" id="img-img">
                          <img alt="image" class="zoomable" id="img" src="{ if($urls[1] = '' or not($urls[1])) then 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==' else (if(not(contains($urls[1], '/'))) then concat($image-base-url, $urls[1]) else $urls[1] ) }" style="z-index:1;position:absolute;"/>
                        </div>
                      </div>
                    </div>
                  </xrx:case>
                  <xrx:case id="dpreview">
                    <span>Preview</span>
                  </xrx:case>
                  <xrx:case id="dcharter-instance"/>
                </xrx:switch>
              </div>
            </xrx:true>
            <xrx:false>
              <div data-demoid="de9f813e-6b5d-49f6-91b3-eee1a1731a7b"/>
            </xrx:false>
          </xrx:auth>
        </xrx:center>
        <xrx:north>
          <div data-demoid="48d984c8-63e8-48df-95bc-00ad1e2b62c5" id="dmy-collection-header">
            <h2>EditMOM</h2>
            <div data-demoid="4c56fbe3-1728-47c6-af7e-ab39fb266752" id="autoSaveStatus"/>
          </div>
          <div data-demoid="4e751e31-7e32-42cd-96a3-ce571b5ea97a" id="image-tool-div">
            <button id="open-image-tool">
              <xrx:i18n>
                <xrx:key>open-image-tools</xrx:key>
                <xrx:default>Open Image Tools</xrx:default>
              </xrx:i18n>
            </button>
          </div>
        </xrx:north>
        <xrx:south id="dtextann">
          <xrx:auth>
            <xrx:rules>
              <xrx:rule>
                <xrx:user/>
                <xrx:dbgroup>atom</xrx:dbgroup>
              </xrx:rule>
            </xrx:rules>
            <xrx:true>
              <div data-demoid="d6062366-8073-43c1-9472-4667e1c44c95" id="dinner-textann">
                <xrx:layout>
                  <xrx:options>
                    <xrx:option key="east__size">.3</xrx:option>
                  </xrx:options>
                  <xrx:center>
                    <div class="xrx-layout" data-demoid="bd089740-6647-48f3-9042-544ae9d31cae" onclick="return {{ north__resizable: false, north__showOverflowOnHover: true }}">
                      <div class="ui-layout-center xrx-tabs" data-demoid="086ae85e-889f-4d7e-b2cd-3e19bd63819f" style="overflow:auto;">
                       <ul> 
                         { 
                         (: if($nodes-for-editcontrol//.[tab_page/text() = "1"]) then:) 
                          if(contains($helper, "<tab_page>1</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-1">
                                <xrx:i18n>
                                  <xrx:key>abstract</xrx:key>
                                  <xrx:default>abstract</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                            ()
                          }
                          { if(contains($helper, "<tab_page>2</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-2">
                                <xrx:i18n>
                                  <xrx:key>fulltext</xrx:key>
                                  <xrx:default>fulltext</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                          { if(contains($helper, "<tab_page>3</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-3">
                                <xrx:i18n>
                                  <xrx:key>source</xrx:key>
                                  <xrx:default>source</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                          { if(contains($helper, "<tab_page>4</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-4">
                                <xrx:i18n>
                                  <xrx:key>description-of-original</xrx:key>
                                  <xrx:default>description of original</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                          { if(contains($helper, "<tab_page>5</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-5">
                                <xrx:i18n>
                                  <xrx:key>copies</xrx:key>
                                  <xrx:default>copies</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                          { if(contains($helper, "<tab_page>6</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-6">
                                <xrx:i18n>
                                  <xrx:key>commentary</xrx:key>
                                  <xrx:default>commentary</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                          { if(contains($helper, "<tab_page>7</tab_page>")) then
                            <li>
                              <a class="anchor" href="#tab-7">
                                <xrx:i18n>
                                  <xrx:key>appendix</xrx:key>
                                  <xrx:default>appendix</xrx:default>
                                </xrx:i18n>
                              </a>
                            </li>
                          else
                          ()
                          }
                        </ul> 
                        <!-- Creates the Content for the specific TabPage
                        ~ Contains the Charter and the distinct nodes from the Charter
                        -->
                        {mycollection:returnTabPageContent("1", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("2", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("3", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("4", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("5", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("6", $entry, $distinct_nodes)}
                        {mycollection:returnTabPageContent("7", $entry, $distinct_nodes)}

                      </div>
                      <div class="ui-layout-north" data-demoid="5da89345-2191-497a-98de-b895609836b1">
                        <div class="dmy-collection-toolbar" data-demoid="f007ba43-bb97-4d77-b520-d58fe71674e7">
                          <xrx:elements/>
                          <span style="font-size:1.6em;"> </span>
                        </div>
                      </div>
                    </div>
                  </xrx:center>
                  <xrx:east>
                    <div class="xrx-layout" data-demoid="10237aca-70ac-46c7-baf6-eb371153610b" onclick="return {{ north__resizable: false }}">
                      <div class="ui-layout-center xrx-tabs" data-demoid="1fbb416a-875f-4730-8ff8-2738bc087545">
                        <ul>
                          <li>
                            <a href="#atab-1">
                              <xrx:i18n>
                                <xrx:key>attributes</xrx:key>
                                <xrx:default>Attributes</xrx:default>
                              </xrx:i18n>
                            </a>
                          </li>
                          <li>
                            <a href="#atab-2" id="tab-validation-report">
                              <xrx:i18n>
                                <xrx:key>validation-report</xrx:key>
                                <xrx:default>Validation Report</xrx:default>
                              </xrx:i18n>
                            </a>
                          </li>
                        </ul>
                        <div data-demoid="aa7f3e52-4827-4461-b9c6-1b45d6634e8d" id="atab-1">
                          <xrx:attributes/>
                        </div>
                        <div data-demoid="a4b8cd5f-f77c-417f-a681-383d0d419a45" id="atab-2">
                          <div class="xrx-report" data-demoid="2e057ed2-f72f-4e57-82b8-59c2cdb7a89e"/>
                        </div>
                      </div>
                      <div class="ui-layout-north" data-demoid="09c01686-e6d0-4ae7-bfa3-4692484cfac5">
                        <div class="dmy-collection-toolbar" data-demoid="d77ece62-d2ce-4928-b045-5ad66686e512">
                          <xrx:tagname> </xrx:tagname>
                        </div>
                      </div>
                    </div>
                  </xrx:east>
                </xrx:layout>
              </div>
            </xrx:true>
            <xrx:false>
              <div data-demoid="b96fe135-5335-414b-8dfc-5836cd60aaff" id="dlogin">
                <xrx:i18n>
                  <xrx:key>protected-page-message</xrx:key>
                  <xrx:default>Protected page. Please login first.</xrx:default>
                </xrx:i18n>
                <xrx:subwidget>tag:www.monasterium.net,2011:/mom/widget/login2</xrx:subwidget>
              </div>
            </xrx:false>
          </xrx:auth>
        </xrx:south>
      </xrx:layout>
      <div data-demoid="255993c7-4e5d-4a9b-90b3-beec82724ac7" id="image-tool-widget">
        <xrx:resource id="image-tool-widget-close-button" title="Close Image Tool" type="image/png">tag:www.monasterium.net,2011:/mom/resource/image/button_close</xrx:resource>
        <div data-demoid="9540bf3f-0242-4de2-9ba0-5359d2224809" id="image-tool-widget-button-bar">
          <button class="image-tool-widget-button" id="create-new-anno-button">
            <xrx:i18n>
              <xrx:key>create-new</xrx:key>
              <xrx:default>Create new</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="save-selection-button">
            <xrx:i18n>
              <xrx:key>save-selection</xrx:key>
              <xrx:default>Save selection</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="edit-anno-button">
            <xrx:i18n>
              <xrx:key>edit-annotation</xrx:key>
              <xrx:default>Edit annotation</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="delete-anno-button">
            <xrx:i18n>
              <xrx:key>delete-annotation</xrx:key>
              <xrx:default>Delete annotation</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="add-metadata-button">
            <xrx:i18n>
              <xrx:key>add-metadata</xrx:key>
              <xrx:default>Add metadata</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="save-metadata-button">
            <xrx:i18n>
              <xrx:key>save-metadata</xrx:key>
              <xrx:default>Save metadata</xrx:default>
            </xrx:i18n>
          </button>
          <button class="image-tool-widget-button" id="show-anno-button">
            <xrx:i18n>
              <xrx:key>show-annotation</xrx:key>
              <xrx:default>Show annotation</xrx:default>
            </xrx:i18n>
          </button>
        </div>
       </div>
      <div class="xrx-message" data-demoid="aa0e9f99-53e1-4893-9290-2cf835e1c3ca"/>
      <div class="xrx-forms-json-attribute-suggestions" data-demoid="a9a1b205-f185-4e4c-8fcc-8d1a397c881e" style="display:none">{ $attribute-suggestions }</div>
      <div class="xrx-forms-json-element-suggestions" data-demoid="90164e9b-8793-4426-9cb3-9c91b1252326" style="display:none">{ $element-suggestions }</div>
      <div class="xrx-forms-json-topics" data-demoid="29dc1908-0c8d-4501-ab7d-5e0cbdc492b9" style="display:none">{ $topics }</div>                 
      <div class="xrx-forms-json-attribute-valuesuggestions" style="display:none">
    {{   
    "cei:index":{{
   "indexName": ["arthistorian"],
    "lemma": ["N1", "N2", "N3"],
    "sublemma": [{{"N1":["HistoriatedDecoration","WithAdditionalColours: Miniatures", "WithAdditionalColours: Initials", "WithAdditionalColours: Borders", "WithAdditionalColours: CoatsofArms", "WithAdditionalColours: ExecutionDraw", "WithAdditionalColours: ExecutionPainted"]}},
    {{"N2": ["DrawnDecorationnothistoriated: DD-nh-Panels", "DrawnDecorationnothistoriated: Initials", "DrawnDecorationnothistoriated: DD-nh-Borders", "DepictiveMotivesnothistoriated: figural", "DepictiveMotivesnothistoriated: zoomorphic", "DepictiveMotivesnothistoriated: otherMotivs"]}},
    {{"N3": ["GraphicMeansofAuthenticating: Chrismon", "GraphicMeansofAuthenticating: Monogramm", "GraphicMeansofAuthenticating: Rota", "GraphicMeansofAuthenticating: SignumRecognitionis", "GraphicMeansofAuthenticating: SignumNotarile", "GraphicMeansofAuthenticating: OtherSignsofAuthentication"]}}
     ]}}}}
</div>
      <script type="text/javascript">
      jQuery(document).ready(function(){{ 
        jQuery.ajaxSetup({{ cache: false }});
        window.XPath = new XPath();
        window.XPath.setNamespaceContext(
            ["atom", "cei"],
            ["http://www.w3.org/2005/Atom", "http://www.monasterium.net/NS/cei"]
            );
        jQuery(document).xmleditor({{
          requestRoot: "{ conf:param('request-root') }"
        }});
        jQuery("#icharter").appendTo("#dcharter-instance").show();
        jQuery(".anchor", "#dinner-textann").click(function() {{
          $(".xrx-visualxml").each(function(){{ $(this).xrxVisualxml("clear"); }});
        }});
      }});
      </script>
    </div>
  </xrx:view>
</xrx:widget>